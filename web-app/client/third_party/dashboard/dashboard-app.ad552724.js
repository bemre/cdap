"use strict";angular.module("dashboard.app",["ngSanitize","ui.bootstrap","ui.sortable","angularLocalStorage"]),angular.module("dashboard.app").directive("dashboard",["ProjectService",function(a){return{scope:{projectId:"@"},templateUrl:"/views/project.html",link:function(b,c){b.$watch("projectId",function(d){console.log(d),d&&"false"!==d?a.loadProjectDetails(d).then(function(a){console.log(a),b.project=a.data,b.project.tabs.length&&b.setCurrentTab(b.project.tabs[0].id),c.show()}):c.hide()})},controller:"ProjectCtrl"}}]).directive("componentWrapper",["ComponentsService","$compile",function(a,b){return{scope:{componentWrapper:"@",endpoint:"@"},link:function(c,d){var e=a.getComponentByNamespace(c.componentWrapper),f=a.componentNameToDirectiveAttribute(e.id);d.html("<div "+f+'="" endpoint="{{endpoint}}"></div>'),b(d.contents())(c)}}}]).directive("editableText",function(){return{scope:{editableText:"="},template:'<div class="form-group form-inline"><span ng-show="!editMode" ng-click="toggleEditMode()" class="editable-text">{{editedText}} </span><span ng-show="editMode"><input type="text" class="form-control input-sm" ng-model="editedText" enter-input="toggleEditMode()"></span><button type="button" class="btn btn-xs" ng-click="toggleEditMode()">{{ buttonLabel }}</button></div>',replace:!0,controller:function(a){a.editedText=a.editableText.toString(),a.buttonLabel="Edit",a.editMode=!1,a.toggleEditMode=function(){a.editMode=!a.editMode,a.editMode?a.buttonLabel="Done":(a.buttonLabel="Edit",a.editableText=a.editedText)}}}}).directive("enterInput",function(){return function(a,b,c){b.bind("keydown",function(b){13===b.keyCode&&a.$apply(c.enterInput)})}}).directive("autoFocus",function(){return function(a,b){b.focus()}}).directive("slugInput",function(){return function(a,b){b.bind("input",function(){var a=b.val().replace(/[^\w-]/gi,"");"/"===a.slice(0,1)&&(a=a.slice(1)),b.val(a.toLowerCase())})}}).directive("numericInput",function(){return function(a,b){b.bind("input",function(){var a=b.val().replace(/[^0-9.]/g,"");b.val(a)})}}),angular.module("dashboard.app").service("SettingsService",["appSettings","storage",function(a,b){function c(a){return i[a].value}function d(a,b){i[a].value=b,angular.forEach(h[a],function(a){a.call(this,b)})}function e(){angular.forEach(a,function(a){a.value=a.default}),b.set("settings",i)}function f(){b.set("settings",i)}function g(a,b){return h[a].push(b),c(a)}var h={},i=angular.copy(a);angular.forEach(i,function(a,b){a.value=a.default,h[b]=[]});var j=b.get("settings")||{};return i=angular.extend(i,j),{getAllSettings:function(){return i},getAllSettingNames:function(){var a=[];return angular.forEach(i,function(b,c){a.push(c)}),a},restoreDefaults:e,getSetting:c,setSetting:d,persist:f,bind:g}}]),angular.module("dashboard.app").service("ComponentsService",["appComponents",function(a){var b=angular.copy(a);return{getAvailableComponents:function(){return b},getComponentByNamespace:function(a){var c={},d=a.split("."),e=d.pop(),f=d.join(".");return console.log("component name",e,"moduleName",f),angular.forEach(b,function(a){if(a.module===f)for(var b=0,d=a.components.length;d>b;b++)if(a.components[b].id===e){c=a.components[b],c.namespace=a.namespace,c.module=a.module;break}}),c},componentNameToDirectiveAttribute:function(a){return a.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}}}]),angular.module("dashboard.app").service("ProjectService",["$http","$q","storage","LayoutHelper","GuidService",function(a,b,c,d,e){function f(a){if(!a.id)return"No project id specified";if(!a.name)return"No project name specified";if(!a.tabs||"object"!=typeof a.tabs)return'Project must contain a "tabs" array';if(!a.tabs.length)return"Your project must contain at least one tab";for(var b=0,c=a.tabs.length;c>b;b++){var d=a.tabs[b];if(!d.id)return"Tab "+(b+1)+" has no id attribute";if(!d.name)return"Tab "+(b+1)+" has no name attribute";if(!d.layout&&"object"!=typeof d.layout)return"Tab "+(b+1)+" has no layout Object";if(!d.layout.rows||"object"!=typeof d.layout.rows)return"Tab "+(b+1)+' layout has no "rows" array';for(var e=0,f=d.layout.rows.length;f>e;e++){var i=d.layout.rows[e],j=g(i);if(j!==!0)return"Tab "+(b+1)+" Row "+(e+1)+" error: "+j;for(var k=0,l=i.cols.length;l>k;k++){var m=i.cols[k],n=h(m);if(n!==!0)return"Tab "+(b+1)+" Row "+(e+1)+" Col "+(k+1)+" error: "+n}}}return!0}function g(a){return a.format&&-1!==k.indexOf(a.format)?a.cols&&"object"==typeof a.cols?!0:'no "cols" array':"invalid row format: "+a.format}function h(a){return a.widgets&&"object"==typeof a.widgets?!0:'no "widgets" array'}var i={id:0,order:0,name:"New Tab",layout:{rows:[]}},j={id:0,name:"",tabs:[]},k=d.getAvailableRowLayoutNames();return{validateProject:f,deleteAllProjects:function(){return c.remove("projects"),!0},getProjects:function(){return c.get("projects")||[]},getBlankProject:function(){return angular.copy(j)},addProject:function(a,f,g){var h=b.defer();return setTimeout(function(){var b=c.get("projects")||[],k=angular.copy(j);k.id=e.guid(),k.name=a;var l=angular.copy(i);l.id=e.guid(),l.order=1,l.name=f;var m=d.getFormattedRow(g);l.layout.rows.push(m),k.tabs.push(l),b.push(k),c.set("projects",b),h.resolve(k)},10),h.promise},deleteProject:function(a){a=a.toString();for(var b=c.get("projects")||[],d=0,e=b.length;e>d;d++)if(b[d].id.toString()===a){b.splice(d,1);break}return c.set("projects",b),b},importProject:function(a){var b=c.get("projects")||[];return b.push(a),c.set("projects",b),a},getProjectById:function(a){a=a.toString();for(var b={},d=c.get("projects")||[],e=0,f=d.length;f>e;e++)if(d[e].id.toString()===a){b=d[e];break}return b},saveProject:function(a){for(var b=a.id,d=c.get("projects")||[],e=0,f=d.length;f>e;e++)if(d[e].id===b){d[e]=a;break}return c.set("projects",d),!0},loadProjectDetails:function(a){a=a.toString();var d=c.get("projects")||[],e=b.defer();return setTimeout(function(){for(var b={},c=0,f=d.length;f>c;c++)if(d[c].id.toString()===a){b.data=d[c];break}e.resolve(b)},10),e.promise},getBlankTab:function(){var a=angular.copy(i);return a.id=e.guid(),a},getBlankRow:function(){return d.getBlankRow()},getBlankColumn:function(){return d.getBlankColumn()},getBlankWidget:function(){var a=d.getBlankWidget();return a}}}]),angular.module("dashboard.app").service("LayoutHelper",["GuidService",function(a){var b=[{val:"COL1",label:"1 column - full row span"},{val:"COL2",label:"2 equal columns (50% each)"},{val:"COL3",label:"3 equal columns (33% each)"},{val:"COL12",label:"1 span left (33%), 2 span right (66%)"},{val:"COL21",label:"2 span left (66%), 1 span right (33%)"}],c={format:"",cols:[]},d={span:0,widgets:[]},e={title:"",endpoint:"",component:""};return{getAvailableRowLayouts:function(){return b},getAvailableRowLayoutNames:function(){var a=[];return angular.forEach(b,function(b){a.push(b.val)}),a},getBlankRow:function(){var b=angular.copy(c);return b.id=a.guid(),b},getBlankColumn:function(){var b=angular.copy(d);return b.id=a.guid(),b},getBlankWidget:function(){var b=angular.copy(e);return b.id=a.guid(),b},getFormattedRow:function(b){var e;switch(b){case"COL1":e=[1];break;case"COL2":e=[1,1];break;case"COL3":e=[1,1,1];break;case"COL12":e=[1,2];break;case"COL21":e=[2,1]}var f=angular.copy(c);f.id=a.guid(),f.format=b;for(var g=0,h=e.length;h>g;g++){var i=angular.copy(d);i.id=a.guid(),i.span=e[g],f.cols.push(i)}return f}}}]),angular.module("dashboard.app").service("ApiService",["$http","SettingsService",function(a,b){function c(){o||(o=!0,e())}function d(){o=!1}function e(){return o&&l.length?void angular.forEach(l,f):!1}function f(b){return!o||b.numFailedRequests>=n?!1:void(b.listeners&&b.listeners.length&&a.get(b.url).success(function(a){b.listeners&&b.listeners.length&&(angular.forEach(b.listeners,function(b){b.callback.call(this,a)}),setTimeout(function(){f(b)},m))}).error(function(){console.error("error calling endpoint",b),b.numFailedRequests++,b.numFailedRequests>=n&&console.error("endpoint failed",b)}))}function g(a,b){for(var c,d=!1,e=Math.random().toString(36).replace(/[^a-z]+/g,""),g=0;g<l.length;g++)if(l[g].url===a){c=l[g],c.listeners.push({registration:e,callback:b}),d=!0;break}return d||(c={url:a,numFailedRequests:0,listeners:[{registration:e,callback:b}]},l.push(c),o&&f(c)),e}function h(a,b){for(var c=0;c<l.length;c++)if(l[c].url===a)if(arguments.length<2)l.splice(c,1);else for(var d=0,e=l[c].listeners.length;e>d;d++){var f=l[c].listeners[d].registration;if(f===b)return l[c].listeners.splice(d,1),0===l[c].listeners.length&&l.splice(c,1),this}return this}function i(){angular.forEach(l,function(a){a.listeners=[]}),l=[]}function j(b){return a.get(b)}function k(a){for(var b=0;b<l.length;b++)if(l[b].url===a)return l[b];return!1}var l=[],m=b.bind("api_call_interval",function(a){m=a}),n=b.bind("api_failed_request_limit",function(a){n=a}),o=!1;return{run:c,stop:d,addEndpoint:g,removeEndpoint:h,removeAllEndpoints:i,callImmediately:j,getAllEndpoints:function(){return l},getEndpoint:k}}]),angular.module("dashboard.app").service("GuidService",function(){function a(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function b(){return(a()+a()+"-"+a()+"-4"+a().substr(0,3)+"-"+a()+"-"+a()+a()+a()).toLowerCase()}return{guid:b}}),angular.module("dashboard.app").controller("ProjectCtrl",["$scope","$modal","$window","ProjectService","LayoutHelper","SettingsService","ComponentsService","ApiService",function(a,b,c,d,e,f,g,h){a.project=d.getBlankProject(),a.availableRowLayouts=e.getAvailableRowLayouts(),a.newRowFormat=a.availableRowLayouts[0].val,a.availableComponents=g.getAvailableComponents(),a.$on("$destroy",function(){h.removeAllEndpoints()}),a.editingRows=!1,a.toggleRowEditingMode=function(){a.editingRows=!a.editingRows},a.sortableWidgetOptions={placeholder:"widget-placeholder",connectWith:".widget-container",cursor:"move",handle:".widget-move-handle",stop:function(){console.log("TO DO: save layout without the $watch statement")}},a.sortableRowOptions={placeholder:"",connectWith:".widget-row",cursor:"move",handle:".move-handle",stop:function(){console.log("TO DO: save layout without the $watch statement")}},a.newTabSettings={name:"",firstTabRowFormat:a.availableRowLayouts[0].val},a.newWidgetSettings={title:"",endpoint:"http://",row:0,col:0,component:""},a.setCurrentTab=function(b){var c;"undefined"==typeof b&&(c=a.project.tabs[0]);for(var d=0,e=a.project.tabs.length;e>d;d++)if(a.project.tabs[d].id===b){c=a.project.tabs[d];break}null===c&&(c=a.project.tabs[0]),a.$evalAsync(function(){a.currentLayout=c})},a.$watch("project",function(a,b){a&&a!==b&&d.saveProject(a)},!0),a.maxTabs=f.getSetting("max_tabs_per_project"),a.addTab=function(){return a.project.tabs.length>=a.maxTabs?(c.alert("You can only add up to "+a.maxTabs+" tabs per project!"),!1):void b.open({templateUrl:"views/modals/add-project-tab.html",controller:"AddTabModalCtrl",scope:a})},a.deleteCurrentTab=function(){if(c.confirm("Are you sure you want to delete this tab/view? There is no UNDO!")){if(1===a.project.tabs.length)return c.alert("You must have at least one tab/view in your project!"),!1;for(var b=a.currentLayout.id,e=0,f=a.project.tabs.length;f>e;e++)if(a.project.tabs[e].id===b){a.project.tabs.splice(e,1);break}d.saveProject(a.project),a.setCurrentTab(a.project.tabs[0].id)}},a.addRow=function(){a.$evalAsync(function(){var b=e.getFormattedRow(a.newRowFormat);a.currentLayout.layout.rows.push(b)})},a.deleteRow=function(b){c.confirm("Are you sure you want to delete this row? There is no UNDO!")&&(a.currentLayout.layout.rows.splice(b,1),d.saveProject(a.project))},a.addWidget=function(){b.open({templateUrl:"views/modals/add-widget.html",controller:"AddWidgetModalCtrl",scope:a})},a.deleteWidget=function(b,e){c.confirm("Are you sure you want to delete this widget? There is no UNDO!")&&(b.widgets.splice(e,1),d.saveProject(a.project))},a.editWidgetSettings=function(a){b.open({templateUrl:"views/modals/widget-settings.html",controller:"WidgetSettingsModalCtrl",resolve:{widget:function(){return a}}})},a.showSettings=function(){b.open({templateUrl:"views/modals/project-settings.html",controller:"ProjectSettingsModalCtrl",scope:a,backdrop:"static"})},a.exportProject=function(){b.open({templateUrl:"views/modals/export-project.html",controller:"ProjectExportModalCtrl",scope:a})}}]).controller("ProjectSettingsModalCtrl",["$scope","$rootScope","$window","$modalInstance","ProjectService",function(a,b,c,d,e){a.editProjectError=!1,a.save=function(){""===a.project.name?a.editProjectError="Your project name cannot be blank!":(b.$emit("projectUpdated"),d.dismiss())},a.cancel=function(){d.dismiss("cancel")},a.deleteProject=function(){c.confirm("Are you sure you want to delete this project? There is no UNDO!")&&(e.deleteProject(a.project.id),b.$emit("projectDeleted"),d.dismiss())}}]).controller("AddTabModalCtrl",["$scope","$rootScope","$modalInstance","ProjectService","LayoutHelper",function(a,b,c,d,e){a.addTabError=!1,a.add=function(){if(""===a.newTabSettings.name)a.addTabError="Please enter a name for your new tab";else{var b=d.getBlankTab();b.order=a.project.tabs.length+1,b.name=a.newTabSettings.name;var f=e.getFormattedRow(a.newTabSettings.firstTabRowFormat);b.layout.rows.push(f),a.project.tabs.push(b),a.newTabSettings.name="",a.newTabSettings.firstTabRowFormat=a.availableRowLayouts[0].val,a.addTabError=!1,a.setCurrentTab(b.id),c.dismiss()}},a.cancel=function(){c.dismiss("cancel")}}]).controller("AddWidgetModalCtrl",["$scope","$rootScope","$modalInstance","ProjectService","ComponentsService",function(a,b,c,d,e){a.addWidgetError=!1,a.requiresEndpoint=!1,a.setWidgetTarget=function(b,c){a.newWidgetSettings.row=b,a.newWidgetSettings.col=c},a.add=function(){if(""===a.newWidgetSettings.title)a.addWidgetError="Please enter a title for your new widget";else if(""===a.newWidgetSettings.component)a.addWidgetError="Please select a component for your widget";else if(a.requiresEndpoint!==!0||""!==a.newWidgetSettings.endpoint&&"http://"!==a.newWidgetSettings.endpoint){var b=d.getBlankWidget();b.title=a.newWidgetSettings.title,b.component=a.newWidgetSettings.component,b.endpoint=a.newWidgetSettings.endpoint,a.currentLayout.layout.rows[a.newWidgetSettings.row].cols[a.newWidgetSettings.col].widgets.push(b),a.newWidgetSettings.title="",a.newWidgetSettings.endpoint="http://",a.newWidgetSettings.component="",a.addWidgetError=!1,a.usingCustomComponent=!0,c.dismiss()}else a.addWidgetError="Please enter an API endpoint for your widget"},a.cancel=function(){c.dismiss("cancel")},a.componentSelected=function(){var b=e.getComponentByNamespace(a.newWidgetSettings.component);a.requiresEndpoint=b.requireEndpoint}}]).controller("WidgetSettingsModalCtrl",["$scope","widget","$modalInstance",function(a,b,c){a.widget=b,a.close=function(){c.dismiss()}}]).controller("ProjectExportModalCtrl",["$scope","$modalInstance",function(a,b){a.close=function(){b.dismiss()}}]);